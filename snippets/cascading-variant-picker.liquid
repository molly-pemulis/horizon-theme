{% comment %}
  CASCADING VARIANT PICKER
  ========================
  - Size: dropdown select
  - Color: swatches/variant photos (rendered server-side with swatch snippet)
  - Prunes unavailable options via JavaScript
  - Shows variant photos when selecting color

  Usage: {% render 'cascading-variant-picker', product_resource: product %}
{% endcomment %}

{% liquid
  assign product = product_resource
  if product == blank
    assign product = closest.product
  endif

  if product == blank and request.visual_preview_mode
    assign product = collections.all.products.first
  endif
%}

{% unless product.has_only_default_variant %}
  <cascading-variant-picker
    class="cascading-picker"
    data-product-id="{{ product.id }}"
    data-product-url="{{ product.url }}"
    data-section-id="{{ section.id }}"
  >
    {%- comment -%} JSON data for JavaScript {%- endcomment -%}
    <script type="application/json" data-variants>
      [
        {%- assign first_available = true -%}
        {%- for variant in product.variants -%}
          {%- if variant.available -%}
            {%- unless first_available -%},{%- endunless -%}
            {%- assign first_available = false -%}
            {
              "id": {{ variant.id }},
              "options": {{ variant.options | json }},
              "price": {{ variant.price }},
              "compare_at_price": {{ variant.compare_at_price | default: 'null' }},
              "sku": {{ variant.sku | json }},
              "featured_image": {% if variant.featured_image %}{{ variant.featured_image | image_url: width: 800 | json }}{% else %}null{% endif %}
            }
          {%- endif -%}
        {%- endfor -%}
      ]
    </script>

    <form class="cascading-picker__form">
      {%- for option in product.options_with_values -%}
        {% assign option_index = forloop.index0 %}
        {% assign option_name_lower = option.name | downcase %}

        {%- comment -%} Check if this is a color-type option {%- endcomment -%}
        {% assign is_color_option = false %}
        {% if option_name_lower contains 'color' or option_name_lower contains 'colour' or option_name_lower contains 'finish' or option_name_lower contains 'shade' %}
          {% assign is_color_option = true %}
        {% endif %}

        <div class="cascading-picker__option" data-option-index="{{ option_index }}">
          <label class="cascading-picker__label-text">
            {{ option.name }}
            <span class="cascading-picker__selected-value" data-selected-label></span>
          </label>

          {% if is_color_option %}
            {%- comment -%} COLOR: Render variant photos as swatches {%- endcomment -%}
            <div class="cascading-picker__swatches" data-option-index="{{ option_index }}" {% if option_index > 0 %}data-disabled="true"{% endif %}>
              {%- for value in option.values -%}
                {% liquid
                  assign value_string = value | escape

                  # Find the first available variant with this color to get its image
                  assign variant_image = null
                  assign variant_image_url = null
                  assign value_available = false

                  for variant in product.variants
                    assign variant_opt = variant.options[option_index] | escape
                    if variant_opt == value_string
                      if variant.available
                        assign value_available = true
                      endif
                      if variant.featured_image and variant_image == null
                        assign variant_image = variant.featured_image
                        assign variant_image_url = variant.featured_image | image_url: width: 800
                      endif
                    endif
                  endfor
                %}
                <button
                  type="button"
                  class="cascading-picker__swatch{% unless value_available %} cascading-picker__swatch--unavailable{% endunless %}"
                  data-option-index="{{ option_index }}"
                  data-value="{{ value | escape }}"
                  {% if variant_image_url %}data-image-url="{{ variant_image_url }}"{% endif %}
                  {% unless value_available %}disabled data-unavailable="true"{% endunless %}
                  title="{{ value }}"
                >
                  {% if variant_image %}
                    <img
                      src="{{ variant_image | image_url: width: 100 }}"
                      alt="{{ value }}"
                      loading="lazy"
                      width="50"
                      height="50"
                    >
                  {% else %}
                    <span class="cascading-picker__swatch-text">{{ value }}</span>
                  {% endif %}
                </button>
              {%- endfor -%}
            </div>
            <input type="hidden" name="option{{ forloop.index }}" data-option-index="{{ option_index }}" value="">

          {% else %}
            {%- comment -%} SIZE/OTHER: Render dropdown {%- endcomment -%}
            <div class="cascading-picker__select-wrapper">
              <select
                name="option{{ forloop.index }}"
                data-option-index="{{ option_index }}"
                {% if option_index > 0 %}disabled{% endif %}
              >
                <option value="" selected disabled>Select {{ option.name }}</option>
                {%- for value in option.values -%}
                  {% liquid
                    assign value_string = value | escape

                    # Check if this value leads to any available variant
                    assign value_available = false
                    for variant in product.variants
                      assign variant_opt = variant.options[option_index] | escape
                      if variant.available and variant_opt == value_string
                        assign value_available = true
                        break
                      endif
                    endfor
                  %}
                  {% if value_available %}
                    <option value="{{ value | escape }}">{{ value }}</option>
                  {% endif %}
                {%- endfor -%}
              </select>
              <svg class="cascading-picker__caret" viewBox="0 0 10 6" aria-hidden="true">
                <path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          {% endif %}
        </div>
      {%- endfor -%}

      <input type="hidden" name="id" value="" data-selected-variant-id>
    </form>
  </cascading-variant-picker>
{% endunless %}

<script>
  class CascadingVariantPicker extends HTMLElement {
    constructor() {
      super();
      this.variants = [];
      this.selections = [];
      this.optionCount = 0;
    }

    connectedCallback() {
      const variantsScript = this.querySelector('script[data-variants]');
      if (variantsScript) {
        try {
          this.variants = JSON.parse(variantsScript.textContent);
        } catch (e) {
          console.error('Failed to parse variants JSON:', e);
          this.variants = [];
        }
      }

      const options = this.querySelectorAll('.cascading-picker__option');
      this.optionCount = options.length;
      this.selections = new Array(this.optionCount).fill(null);

      // Bind dropdown changes
      this.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', this.handleSelectChange.bind(this));
      });

      // Bind swatch clicks
      this.querySelectorAll('.cascading-picker__swatch').forEach(swatch => {
        swatch.addEventListener('click', this.handleSwatchClick.bind(this));
      });

      // Initial state - prune first option if it's a dropdown
      const firstSelect = this.querySelector('select[data-option-index="0"]');
      if (firstSelect) {
        this.pruneSelect(0);
      }
    }

    handleSelectChange(event) {
      const select = event.target;
      const optionIndex = parseInt(select.dataset.optionIndex);
      const value = select.value;

      this.selections[optionIndex] = value;
      this.clearSubsequentSelections(optionIndex);
      this.updateLabels();
      this.enableNextOption(optionIndex);
      this.checkComplete();
    }

    handleSwatchClick(event) {
      const swatch = event.currentTarget;
      if (swatch.disabled) return;

      const optionIndex = parseInt(swatch.dataset.optionIndex);
      const value = swatch.dataset.value;
      const imageUrl = swatch.dataset.imageUrl;

      // Update selection
      this.selections[optionIndex] = value;

      // Update hidden input
      const hiddenInput = this.querySelector(`input[type="hidden"][data-option-index="${optionIndex}"]`);
      if (hiddenInput) hiddenInput.value = value;

      // Update active state
      const container = swatch.closest('.cascading-picker__swatches');
      container.querySelectorAll('.cascading-picker__swatch').forEach(s => {
        s.classList.remove('cascading-picker__swatch--active');
      });
      swatch.classList.add('cascading-picker__swatch--active');

      // Update main product image
      if (imageUrl) {
        this.updateMainImage(imageUrl);
      }

      this.clearSubsequentSelections(optionIndex);
      this.updateLabels();
      this.enableNextOption(optionIndex);
      this.checkComplete();
    }

    clearSubsequentSelections(fromIndex) {
      for (let i = fromIndex + 1; i < this.optionCount; i++) {
        this.selections[i] = null;

        // Reset select dropdowns
        const select = this.querySelector(`select[data-option-index="${i}"]`);
        if (select) {
          select.selectedIndex = 0;
          select.disabled = true;
        }

        // Reset swatch containers
        const swatchContainer = this.querySelector(`.cascading-picker__swatches[data-option-index="${i}"]`);
        if (swatchContainer) {
          swatchContainer.dataset.disabled = 'true';
          swatchContainer.querySelectorAll('.cascading-picker__swatch').forEach(s => {
            s.classList.remove('cascading-picker__swatch--active');
          });
        }

        // Reset hidden inputs
        const hiddenInput = this.querySelector(`input[type="hidden"][data-option-index="${i}"]`);
        if (hiddenInput) hiddenInput.value = '';
      }
    }

    enableNextOption(currentIndex) {
      const nextIndex = currentIndex + 1;
      if (nextIndex >= this.optionCount) return;

      // Enable and prune next select
      const nextSelect = this.querySelector(`select[data-option-index="${nextIndex}"]`);
      if (nextSelect) {
        nextSelect.disabled = false;
        this.pruneSelect(nextIndex);
      }

      // Enable and prune next swatch container
      const nextSwatches = this.querySelector(`.cascading-picker__swatches[data-option-index="${nextIndex}"]`);
      if (nextSwatches) {
        nextSwatches.dataset.disabled = 'false';
        this.pruneSwatches(nextIndex);
      }
    }

    pruneSelect(optionIndex) {
      const select = this.querySelector(`select[data-option-index="${optionIndex}"]`);
      if (!select) return;

      const availableValues = this.getAvailableValues(optionIndex);

      // Show/hide options
      Array.from(select.options).forEach(option => {
        if (option.value === '') return; // Keep placeholder
        option.style.display = availableValues.includes(option.value) ? '' : 'none';
        option.disabled = !availableValues.includes(option.value);
      });

      // Auto-select if only one available
      const visibleOptions = Array.from(select.options).filter(o => o.value && !o.disabled);
      if (visibleOptions.length === 1) {
        select.value = visibleOptions[0].value;
        select.dispatchEvent(new Event('change'));
      }
    }

    pruneSwatches(optionIndex) {
      const container = this.querySelector(`.cascading-picker__swatches[data-option-index="${optionIndex}"]`);
      if (!container) return;

      const availableValues = this.getAvailableValues(optionIndex);

      container.querySelectorAll('.cascading-picker__swatch').forEach(swatch => {
        const value = swatch.dataset.value;
        if (availableValues.includes(value)) {
          swatch.style.display = '';
          swatch.disabled = false;
          swatch.classList.remove('cascading-picker__swatch--unavailable');
        } else {
          swatch.style.display = 'none';
          swatch.disabled = true;
          swatch.classList.add('cascading-picker__swatch--unavailable');
        }
      });

      // Auto-select if only one available
      const visibleSwatches = container.querySelectorAll('.cascading-picker__swatch:not([disabled])');
      if (visibleSwatches.length === 1) {
        visibleSwatches[0].click();
      }
    }

    getAvailableValues(optionIndex) {
      let matchingVariants = this.variants;

      // Filter by prior selections
      for (let i = 0; i < optionIndex; i++) {
        if (this.selections[i] !== null) {
          matchingVariants = matchingVariants.filter(v => v.options[i] === this.selections[i]);
        }
      }

      return [...new Set(matchingVariants.map(v => v.options[optionIndex]))];
    }

    updateLabels() {
      this.querySelectorAll('[data-selected-label]').forEach((label, i) => {
        label.textContent = this.selections[i] ? `: ${this.selections[i]}` : '';
      });
    }

    updateMainImage(imageUrl) {
      const mainImage = document.querySelector('.product-media__image');
      if (mainImage && imageUrl) {
        mainImage.src = imageUrl;
        mainImage.srcset = '';
      }
    }

    checkComplete() {
      const hiddenInput = this.querySelector('[data-selected-variant-id]');
      const allSelected = this.selections.every(s => s !== null);

      if (allSelected) {
        const variant = this.variants.find(v =>
          v.options.every((opt, i) => opt === this.selections[i])
        );

        if (variant) {
          hiddenInput.value = variant.id;

          this.dispatchEvent(new CustomEvent('variant:selected', {
            bubbles: true,
            detail: { variant, sectionId: this.dataset.sectionId }
          }));

          this.dispatchEvent(new CustomEvent('variant:update', {
            bubbles: true,
            detail: {
              resource: {
                id: variant.id,
                available: true,
                price: variant.price,
                compare_at_price: variant.compare_at_price,
                sku: variant.sku,
                featured_media: variant.featured_image ? { preview_image: { src: variant.featured_image } } : null
              },
              sourceId: this.dataset.sectionId,
              data: { productId: this.dataset.productId, html: document }
            }
          }));
        }
      } else {
        hiddenInput.value = '';
        this.dispatchEvent(new CustomEvent('variant:update', {
          bubbles: true,
          detail: {
            resource: null,
            sourceId: this.dataset.sectionId,
            data: { productId: this.dataset.productId, html: document }
          }
        }));
      }
    }
  }

  if (!customElements.get('cascading-variant-picker')) {
    customElements.define('cascading-variant-picker', CascadingVariantPicker);
  }
</script>

{% stylesheet %}
  .cascading-picker {
    width: 100%;
  }

  .cascading-picker__form {
    display: flex;
    flex-direction: column;
    gap: var(--gap-md, 16px);
  }

  .cascading-picker__option {
    display: flex;
    flex-direction: column;
    gap: var(--gap-xs, 4px);
  }

  .cascading-picker__label-text {
    font-weight: var(--font-weight-semibold, 600);
  }

  .cascading-picker__selected-value {
    font-weight: normal;
    color: rgb(var(--color-foreground-rgb, 0 0 0) / 0.7);
  }

  /* Dropdown styles */
  .cascading-picker__select-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
  }

  .cascading-picker__select-wrapper select {
    width: 100%;
    padding: var(--padding-sm, 8px) var(--padding-lg, 16px);
    padding-right: 40px;
    appearance: none;
    border: var(--style-border-width-inputs, 1px) solid var(--color-border, #ccc);
    border-radius: var(--style-border-radius-inputs, 4px);
    background: var(--color-background, #fff);
    cursor: pointer;
    font-size: inherit;
  }

  .cascading-picker__select-wrapper select:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: rgb(0 0 0 / 0.05);
  }

  .cascading-picker__caret {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    width: 10px;
    height: 10px;
    pointer-events: none;
  }

  /* Swatch container */
  .cascading-picker__swatches {
    display: flex;
    flex-wrap: wrap;
    gap: var(--gap-sm, 8px);
  }

  .cascading-picker__swatches[data-disabled="true"] {
    opacity: 0.4;
    pointer-events: none;
  }

  /* Swatch button with variant photo */
  .cascading-picker__swatch {
    width: 60px;
    height: 60px;
    padding: 0;
    border: 2px solid var(--color-border, #ccc);
    border-radius: var(--style-border-radius-inputs, 4px);
    background: var(--color-background, #fff);
    cursor: pointer;
    overflow: hidden;
    transition: border-color 0.15s ease;
  }

  .cascading-picker__swatch img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .cascading-picker__swatch:hover:not(:disabled) {
    border-color: var(--color-foreground, #000);
  }

  .cascading-picker__swatch--active {
    border-color: var(--color-foreground, #000);
    border-width: 2px;
  }

  .cascading-picker__swatch--unavailable {
    display: none;
  }

  .cascading-picker__swatch:disabled {
    cursor: not-allowed;
    opacity: 0.4;
  }

  .cascading-picker__swatch-text {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    font-size: 10px;
    text-align: center;
    padding: 4px;
    word-break: break-word;
  }
{% endstylesheet %}

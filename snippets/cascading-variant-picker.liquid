{% comment %}
  CASCADING VARIANT PICKER
  ========================
  - Prunes unavailable variants completely
  - First option shows "Select [Option Name]" 
  - Subsequent options disabled until previous selected
  - Only shows options that have available inventory
  - Works with 1, 2, or 3 option products
  
  Usage: {% render 'cascading-variant-picker', product_resource: product %}
{% endcomment %}

{% liquid
  assign product = product_resource
  if product == blank
    assign product = closest.product
  endif
  
  if product == blank and request.visual_preview_mode
    assign product = collections.all.products.first
  endif
%}

{% unless product.has_only_default_variant %}
  <cascading-variant-picker
    class="cascading-picker"
    data-product-id="{{ product.id }}"
    data-product-url="{{ product.url }}"
    data-section-id="{{ section.id }}"
  >
    {%- comment -%} Available variants JSON {%- endcomment -%}
    <script type="application/json" data-variants>
      [
        {%- for variant in product.variants -%}
          {%- if variant.available -%}
            {
              "id": {{ variant.id }},
              "options": {{ variant.options | json }},
              "price": {{ variant.price }},
              "compare_at_price": {{ variant.compare_at_price | default: 'null' }},
              "sku": {{ variant.sku | json }},
              "featured_image": {% if variant.featured_image %}{{ variant.featured_image | image_url: width: 800 | json }}{% else %}null{% endif %}
            }{% unless forloop.last %},{% endunless %}
          {%- endif -%}
        {%- endfor -%}
      ]
    </script>
    
    <script type="application/json" data-options>
      {{ product.options_with_values | json }}
    </script>

    <form class="cascading-picker__form">
      {%- for option in product.options_with_values -%}
        {% assign option_index = forloop.index0 %}
        <div class="cascading-picker__option" data-option-index="{{ option_index }}">
          <label for="CascadeOption-{{ product.id }}-{{ option_index }}">
            {{ option.name }}
            <span class="cascading-picker__selected-value" data-selected-label></span>
          </label>
          <div class="cascading-picker__select-wrapper">
            <select
              id="CascadeOption-{{ product.id }}-{{ option_index }}"
              name="option{{ forloop.index }}"
              data-option-index="{{ option_index }}"
              {% if option_index > 0 %}disabled{% endif %}
            >
              <option value="" selected disabled>
                Select {{ option.name }}
              </option>
              {%- if option_index == 0 -%}
                {%- assign shown_values = '' -%}
                {%- for variant in product.variants -%}
                  {%- if variant.available -%}
                    {%- assign option_value = variant.options[0] -%}
                    {%- unless shown_values contains option_value -%}
                      <option value="{{ option_value | escape }}">
                        {{ option_value }}
                      </option>
                      {%- capture shown_values -%}{{ shown_values }}|{{ option_value }}{%- endcapture -%}
                    {%- endunless -%}
                  {%- endif -%}
                {%- endfor -%}
              {%- endif -%}
            </select>
            <svg class="cascading-picker__caret" viewBox="0 0 10 6" aria-hidden="true">
              <path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
      {%- endfor -%}
      
      <input type="hidden" name="id" value="" data-selected-variant-id>
    </form>
  </cascading-variant-picker>
{% endunless %}

{% comment %} Only load JS once per page {% endcomment %}
{% unless cascading_picker_js_loaded %}
  {% assign cascading_picker_js_loaded = true %}
  <script>
    /**
     * CASCADING VARIANT PICKER
     * Progressive variant selection with pruned unavailable options
     */
    class CascadingVariantPicker extends HTMLElement {
      constructor() {
        super();
        this.variants = [];
        this.options = [];
        this.selections = [];
      }

      connectedCallback() {
        const variantsScript = this.querySelector('script[data-variants]');
        const optionsScript = this.querySelector('script[data-options]');
        
        if (variantsScript) this.variants = JSON.parse(variantsScript.textContent);
        if (optionsScript) this.options = JSON.parse(optionsScript.textContent);
        
        this.selections = new Array(this.options.length).fill(null);
        
        this.querySelectorAll('select').forEach(select => {
          select.addEventListener('change', this.handleChange.bind(this));
        });
      }

      handleChange(event) {
        const select = event.target;
        const optionIndex = parseInt(select.dataset.optionIndex);
        const value = select.value;
        
        this.selections[optionIndex] = value;
        
        // Clear selections after this one
        for (let i = optionIndex + 1; i < this.selections.length; i++) {
          this.selections[i] = null;
        }
        
        this.updateDropdowns(optionIndex);
        this.updateLabels();
        this.checkComplete();
      }

      updateDropdowns(fromIndex) {
        const selects = this.querySelectorAll('select');
        
        for (let i = fromIndex + 1; i < selects.length; i++) {
          const select = selects[i];
          const availableValues = this.getAvailableValues(i);
          
          // Clear options except placeholder
          while (select.options.length > 1) select.remove(1);
          
          // Add available options
          availableValues.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            select.appendChild(option);
          });
          
          // Enable if previous is selected
          select.disabled = this.selections[i - 1] === null;
          select.selectedIndex = 0;
        }
      }

      getAvailableValues(optionIndex) {
        let matchingVariants = this.variants;
        
        for (let i = 0; i < optionIndex; i++) {
          if (this.selections[i] !== null) {
            matchingVariants = matchingVariants.filter(v => v.options[i] === this.selections[i]);
          }
        }
        
        return [...new Set(matchingVariants.map(v => v.options[optionIndex]))];
      }

      updateLabels() {
        this.querySelectorAll('[data-selected-label]').forEach((label, i) => {
          label.textContent = this.selections[i] ? `: ${this.selections[i]}` : '';
        });
      }

      checkComplete() {
        const hiddenInput = this.querySelector('[data-selected-variant-id]');
        const numOptions = this.options.length;
        const numSelected = this.selections.filter(s => s !== null).length;
        
        if (numSelected === numOptions) {
          const variant = this.variants.find(v => 
            v.options.every((opt, i) => opt === this.selections[i])
          );
          
          if (variant) {
            hiddenInput.value = variant.id;
            
            // Dispatch event for price/image/cart updates
            this.dispatchEvent(new CustomEvent('variant:selected', {
              bubbles: true,
              detail: { variant, sectionId: this.dataset.sectionId }
            }));
          }
        } else {
          hiddenInput.value = '';
        }
      }
    }

    if (!customElements.get('cascading-variant-picker')) {
      customElements.define('cascading-variant-picker', CascadingVariantPicker);
    }
  </script>
{% endunless %}

{% stylesheet %}
  .cascading-picker {
    width: 100%;
  }
  
  .cascading-picker__form {
    display: flex;
    flex-direction: column;
    gap: var(--gap-md, 16px);
  }
  
  .cascading-picker__option label {
    display: block;
    margin-bottom: var(--margin-2xs, 4px);
    font-weight: var(--font-weight-semibold, 600);
  }
  
  .cascading-picker__selected-value {
    font-weight: normal;
    color: rgb(var(--color-foreground-rgb, 0 0 0) / 0.7);
  }
  
  .cascading-picker__select-wrapper {
    position: relative;
  }
  
  .cascading-picker__select-wrapper select {
    width: 100%;
    padding: var(--padding-sm, 8px) var(--padding-lg, 16px);
    padding-right: 40px;
    appearance: none;
    border: var(--style-border-width-inputs, 1px) solid var(--color-border, #ccc);
    border-radius: var(--style-border-radius-inputs, 4px);
    background: var(--color-background, #fff);
    cursor: pointer;
    font-size: inherit;
  }
  
  .cascading-picker__select-wrapper select:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: rgb(0 0 0 / 0.05);
  }
  
  .cascading-picker__select-wrapper select:focus {
    outline: 2px solid var(--color-foreground, #000);
    outline-offset: 2px;
  }
  
  .cascading-picker__caret {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    width: 10px;
    height: 10px;
    pointer-events: none;
  }
{% endstylesheet %}

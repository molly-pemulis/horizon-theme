{% comment %}
  COLOR CAROUSEL
  ==============
  Horizontal scrollable carousel of variant color images.
  Click to preview (changes main image) but doesn't select variant.
  
  Usage: {% render 'color-carousel', product: product %}
{% endcomment %}

{% liquid
  assign product = product | default: closest.product
  if product == blank and request.visual_preview_mode
    assign product = collections.all.products.first
  endif
  
  # Get available variants with images
  assign has_variant_images = false
  for variant in product.variants
    if variant.available and variant.featured_image != blank
      assign has_variant_images = true
      break
    endif
  endfor
%}

{% if has_variant_images %}
  <div class="color-carousel" data-product-id="{{ product.id }}">
    <div class="color-carousel__track">
      {%- assign shown_images = '' -%}
      {%- for variant in product.variants -%}
        {%- if variant.available and variant.featured_image != blank -%}
          {%- assign image_src = variant.featured_image | image_url: width: 100 -%}
          {%- unless shown_images contains image_src -%}
            <button 
              type="button"
              class="color-carousel__item"
              data-image-url="{{ variant.featured_image | image_url: width: 800 }}"
              data-variant-title="{{ variant.title | escape }}"
              aria-label="Preview {{ variant.title }}"
            >
              <img 
                src="{{ image_src }}" 
                alt="{{ variant.title | escape }}"
                loading="lazy"
                width="60"
                height="60"
              >
            </button>
            {%- capture shown_images -%}{{ shown_images }}|{{ image_src }}{%- endcapture -%}
          {%- endunless -%}
        {%- endif -%}
      {%- endfor -%}
    </div>
  </div>
  
  <script>
    (function() {
      // Only init once
      if (window.colorCarouselInit) return;
      window.colorCarouselInit = true;
      
      document.addEventListener('click', function(e) {
        const item = e.target.closest('.color-carousel__item');
        if (!item) return;
        
        const imageUrl = item.dataset.imageUrl;
        if (!imageUrl) return;
        
        // Update main product image
        const mainImage = document.querySelector('.product-media__image');
        if (mainImage) {
          mainImage.src = imageUrl;
          mainImage.srcset = '';
        }
        
        // Update active state in carousel
        const carousel = item.closest('.color-carousel');
        carousel.querySelectorAll('.color-carousel__item').forEach(i => {
          i.classList.remove('color-carousel__item--active');
        });
        item.classList.add('color-carousel__item--active');
      });
    })();
  </script>
{% endif %}

{% stylesheet %}
  .color-carousel {
    width: 100%;
    overflow: hidden;
    margin-top: var(--gap-sm, 8px);
  }
  
  .color-carousel__track {
    display: flex;
    gap: var(--gap-xs, 6px);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 4px 0;
  }
  
  .color-carousel__track::-webkit-scrollbar {
    display: none;
  }
  
  .color-carousel__item {
    flex: 0 0 auto;
    width: 60px;
    height: 60px;
    padding: 0;
    border: 2px solid transparent;
    border-radius: var(--style-border-radius-inputs, 4px);
    background: var(--color-background, #fff);
    cursor: pointer;
    overflow: hidden;
    scroll-snap-align: start;
    transition: border-color 0.15s ease;
  }
  
  .color-carousel__item:hover {
    border-color: rgb(var(--color-foreground-rgb, 0 0 0) / 0.3);
  }
  
  .color-carousel__item--active {
    border-color: var(--color-foreground, #000);
  }
  
  .color-carousel__item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
{% endstylesheet %}
